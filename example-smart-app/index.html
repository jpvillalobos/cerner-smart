<!DOCTYPE html>
<html>
 <head>
    <!--script src="node_modules/fhirclient/fhir-client.js"></script-->
     <script src='./lib/js/fhir-client-v0.1.12.js'></script>
     <link rel="stylesheet" href="src/css/example-smart-app.css">
     <span class="title">Smart on FHIR Enabled App</span>
 </head>
 <body>
    <div class="container">
        <br>
            <span class="label">Name:</span>
            <span id="name">Loading Patient Name...</span></h1>
        </br>
        <br>
            <span class="label">DOB:</span>
            <span id="dob">Loading Patient DOB...</span></h1>
        </br>
        <br>
            <span class="label">Gender:</span>
            <span id="gender">Loading Patient Gender...</span></h1>
        </br>
        <br>
            <span class="label">Medical Record Number (MRN):</span>
            <span id="mrn">Loading Patient MRN...</span></h1>
        </br>
    </div>

    <div class="container"> 
        <br>  
            <button type="button" class="IDButton" onclick="getIDs()">Get IDs</button>
        </br>
        <br>
            <span class="label">Internal ID:</span>
            <span id="intID">Loading...</span></h1>
        </br>
        <br>
            <span class="label">External ID:</span>
            <span id="extID">Loading...</span></h1>
        </br>
    </div>
    <br><br/>
    <div class="container">
        <br>   
            <button type="button" id="COButton" class="IDButton" onclick="getCOData()" disabled="disabled">Get Care Orchestrator Data</button>
        <br/>
        <br>
            <iframe id="COPDF" width="800" height="900"></iframe>
        <br/>
    </div>
    
    <script type="text/javascript">
        function UserAction() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    alert(this.responseText);
                }
            };
            xhttp.open("POST", "Your Rest URL Here", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send("Your JSON Data Here");
        }
        // ONE BUTTON FOR CO Data and one for ID mapping (internal + external ID)
        //CO greyed out until ID retrieved (or message)

        function getPatientName(pt) {
            if (pt.name) {
                var names = pt.name.map(function(name) {
                    return name.given.join(" ") + " " + name.family.join(" ");
                });
                return names.join(" / ");
            } else {
                return "anonymous";
            }
        }
        
        function displayPatient (pt) {
            document.getElementById('name').innerHTML = getPatientName(pt);
        }

        function displayPatientDOB(pt) {
            if (pt.birthDate) {
                document.getElementById("dob").innerHTML = pt.birthDate.toString();
            } else {
                echo("Could not get DOB");
            }
        }
        function displayPatientGender(pt) {
            if (pt.gender) {
                document.getElementById("gender").innerHTML = pt.gender.toString();
            } else {
                echo("Could not get DOB");
            }
        }
        function getMRNIdentifier(patient) {
            const identifiers = patient.identifier ? patient.identifier : [];
            const identifier = identifiers.filter(identifier => {
                if (!identifier.type) return false;
                if (!identifier.type.coding) return false;
                const v = identifier.type.coding.find(code => {
                    return code.code === "MR";
                });
                return v !== undefined;
            })[0];
            if (identifier) return identifier.value;
            else return undefined;
        }

        function displayPatientMRN(pt) {
            if (pt.identifier) {
                document.getElementById("mrn").innerHTML = getMRNIdentifier(pt);
                echo("Could not get MRN");
            }
        }
      
        FHIR.oauth2.ready(function(smart) {
            smart.patient.read().then(function(pt) {
                displayPatient (pt);
                displayPatientDOB(pt);
                displayPatientGender(pt);
                displayPatientMRN(pt);
            });
           
        });

        function getIDs(){
            document.getElementById("intID").innerHTML = "007";
            document.getElementById("extID").innerHTML = "456";
            document.getElementById("COButton").disabled = false;
        }

        function getCOData(){
            document.getElementById("COPDF").src = "http://maketto1351.com/wp-content/uploads/2021/04/Maketto-Menu_April-2021.pdf";
        }

    </script>
 </body>
</html>
